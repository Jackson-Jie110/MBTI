{% extends "base.html" %}
{% block title %}å…¨æ¯ç»´åº¦åˆ†æ Â· MBTI{% endblock %}

{% block content %}
  <div class="result-page">
    <div class="card result-hero">
      <div class="result-hero__header">
        <h1 class="result-hero__type">
          <span class="result-hero__type-label">å…¨æ¯ç»´åº¦åˆ†æ</span>
        </h1>
        <p class="muted result-hero__subtitle">ä½ çš„ RPG è§’è‰²å±æ€§é¢æ¿</p>
        <p class="muted result-hero__desc">åŸºäº MBTI å››ç»´ç™¾åˆ†æ¯”ï¼Œæ˜ å°„ä¸º 6 é¡¹èƒ½åŠ›ç»´åº¦ï¼ˆ0-100ï¼‰ã€‚</p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">å…­ç»´æ½œèƒ½é›·è¾¾å›¾</span>
      </h2>

      <div class="relative w-full h-[350px] md:h-[400px] flex justify-center items-center" style="height: 350px; position: relative;">
        <canvas id="radarChart" aria-label="å…­ç»´æ½œèƒ½é›·è¾¾å›¾" role="img"></canvas>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">ä¸ªäººä½¿ç”¨è¯´æ˜ä¹¦</span>
      </h2>

      {% set manual = fun_analysis.get("manual", {}) %}
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <section class="p-5 rounded-xl border bg-green-50 border-green-200">
          <h3 class="text-base font-bold text-green-900 mb-3">âœ… æ­£ç¡®é¥²å…»æŒ‡å—</h3>
          <ul class="list-disc list-inside space-y-1 text-sm text-green-900" style="list-style: disc; padding-left: 18px;">
            {% for item in manual.get("do_list", []) %}
              <li>{{ item }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="p-5 rounded-xl border bg-red-50 border-red-200">
          <h3 class="text-base font-bold text-red-900 mb-3">âŒ ç¦å¿Œæ“ä½œé¢„è­¦</h3>
          <ul class="list-disc list-inside space-y-1 text-sm text-red-900" style="list-style: disc; padding-left: 18px;">
            {% for item in manual.get("dont_list", []) %}
              <li>{{ item }}</li>
            {% endfor %}
          </ul>
        </section>

        <section class="p-5 rounded-xl border bg-blue-50 border-blue-200">
          <h3 class="text-base font-bold text-blue-900 mb-3">ğŸ”‹ å¿«é€Ÿå……ç”µæ–¹å¼</h3>
          <p class="text-sm text-blue-900 leading-relaxed">{{ manual.get("recharge", "") }}</p>
        </section>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">
        <span class="card-title__text">ç»´åº¦æˆ˜äº‰</span>
      </h2>

      {% set war = fun_analysis.get("war", {}) %}

      <div class="w-full rounded-2xl border border-gray-200 overflow-hidden bg-gray-50" style="border-radius: 16px; overflow: hidden;">
        <div class="flex h-10">
          <div
            class="bg-indigo-600 text-white flex items-center justify-start px-3 text-xs font-semibold"
            style="width: {{ war_left_percent }}%;"
            title="{{ war_left_pole }} {{ war_left_percent }}%"
          >
            {{ war_left_pole }} {{ war_left_percent }}%
          </div>
          <div
            class="bg-pink-500 text-white flex items-center justify-end px-3 text-xs font-semibold"
            style="width: {{ war_right_percent }}%;"
            title="{{ war_right_pole }} {{ war_right_percent }}%"
          >
            {{ war_right_pole }} {{ war_right_percent }}%
          </div>
        </div>

        <div class="flex items-center justify-center" style="margin-top: -18px; margin-bottom: 8px;">
          <div class="w-10 h-10 rounded-full bg-white shadow border flex items-center justify-center text-lg" style="width: 40px; height: 40px;">
            âš”ï¸
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="font-bold text-gray-900">{{ war.get("title", conflict_pair) }}</div>
        <p class="mt-1 text-sm text-gray-600 leading-relaxed">{{ war.get("description", "") }}</p>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <a class="btn" href="/">å†æµ‹ä¸€æ¬¡</a>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', path='js/chart.umd.min.js') }}" data-chartjs="1"></script>
  <script>
    (function () {
      const canvas = document.getElementById("radarChart");
      if (!canvas) return;

      let radarData = {{ radar_data_json | safe }};
      if (!Array.isArray(radarData) || radarData.length !== 6) radarData = [50, 50, 50, 50, 50, 50];

      const chartSrc = "{{ url_for('static', path='js/chart.umd.min.js') }}";

      function ensureChart(ready) {
        if (typeof Chart !== "undefined") return ready();

        const existing = document.querySelector("script[data-chartjs=\"1\"]");
        if (existing) {
          existing.addEventListener("load", () => ready(), { once: true });
          existing.addEventListener("error", () => {}, { once: true });
          return;
        }

        const s = document.createElement("script");
        s.src = chartSrc;
        s.async = true;
        s.dataset.chartjs = "1";
        s.onload = () => ready();
        document.body.appendChild(s);
      }

      function render() {
        if (typeof Chart === "undefined") return;

        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        if (window.__mbtiRadarChart) {
          try {
            window.__mbtiRadarChart.destroy();
          } catch {}
        }

        window.__mbtiRadarChart = new Chart(ctx, {
          type: "radar",
          data: {
            labels: ["åˆ›é€ åŠ›", "æ‰§è¡ŒåŠ›", "é€»è¾‘åŠ›", "å…±æƒ…åŠ›", "é€‚åº”åŠ›", "ç¤¾äº¤åŠ›"],
            datasets: [
              {
                label: "èƒ½åŠ›æ½œèƒ½",
                data: radarData,
                backgroundColor: "rgba(99, 102, 241, 0.2)",
                fill: true,
                borderColor: "#6366f1",
                borderWidth: 2,
                tension: 0,
                pointBackgroundColor: "#6366f1",
                pointBorderColor: "#fff",
                pointRadius: 4,
                pointHoverRadius: 6,
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "#6366f1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                suggestedMin: 0,
                suggestedMax: 100,
                grid: {
                  circular: false,
                  color: "rgba(0, 0, 0, 0.05)",
                },
                angleLines: { color: "rgba(0, 0, 0, 0.05)" },
                pointLabels: {
                  font: { size: 12, family: "'Inter', sans-serif" },
                  color: "#4b5563",
                },
                ticks: { display: false, stepSize: 20 },
              },
            },
            plugins: {
              legend: { display: false },
            },
          },
        });
      }

      ensureChart(render);
    })();
  </script>
{% endblock %}
