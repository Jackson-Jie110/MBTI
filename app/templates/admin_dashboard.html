<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户反馈控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f8fafc;
            background-image: radial-gradient(circle at top right, rgba(147, 51, 234, 0.10), transparent 45%),
                              radial-gradient(circle at top left, rgba(236, 72, 153, 0.08), transparent 40%);
        }
        .gradient-text {
            background-image: linear-gradient(90deg, #9333ea, #db2777);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
    </style>
</head>
<body class="text-gray-700 font-sans min-h-screen">
    <nav class="bg-white/85 backdrop-blur-md border-b border-purple-100 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-pink-600 rounded-lg flex items-center justify-center text-white shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-6m3 6V7m3 10v-4m3 8H6a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2v14a2 2 0 01-2 2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold gradient-text">用户反馈控制台</h1>
                    <p class="text-xs text-purple-500">运营洞察 / 系统监控</p>
                </div>
            </div>
            <div class="flex gap-3">
                <a
                    href="{{ request.url_for('export_feedbacks') }}?key={{ request.query_params.get('key', '') }}"
                    class="flex items-center gap-2 px-4 py-2 bg-emerald-50 border border-emerald-200 text-emerald-700 rounded-lg text-sm font-medium hover:bg-emerald-100 transition-colors shadow-sm cursor-pointer"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 16V4m0 12l-4-4m4 4l4-4M4 20h16" />
                    </svg>
                    导出 Excel
                </a>
                <a
                    href="/"
                    class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 transition-colors cursor-pointer"
                >
                    返回首页
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-10">
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <article class="bg-white p-6 rounded-2xl border border-purple-100 shadow-[0_8px_30px_-16px_rgba(147,51,234,0.35)]">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-purple-50 flex items-center justify-center text-purple-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5V4H2v16h5m10 0v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6m10 0H7" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider">累计反馈</div>
                        <div class="text-4xl font-black text-gray-800" id="total-count-value">{{ total_count }}</div>
                    </div>
                </div>
            </article>
            <article class="bg-white p-6 rounded-2xl border border-pink-100 shadow-[0_8px_30px_-16px_rgba(219,39,119,0.35)]">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 rounded-2xl bg-pink-50 flex items-center justify-center text-pink-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l2.037 6.271a1 1 0 00.95.69h6.594c.969 0 1.371 1.24.588 1.81l-5.335 3.876a1 1 0 00-.364 1.118l2.037 6.271c.3.922-.755 1.688-1.538 1.118l-5.335-3.877a1 1 0 00-1.176 0l-5.335 3.877c-.783.57-1.838-.196-1.539-1.118l2.038-6.271a1 1 0 00-.364-1.118L.88 11.698c-.783-.57-.38-1.81.588-1.81h6.594a1 1 0 00.95-.69l2.037-6.271z" />
                        </svg>
                    </div>
                    <div>
                        <div class="text-gray-400 text-xs font-bold uppercase tracking-wider">平均评分</div>
                        <div class="text-4xl font-black text-gray-800" id="avg-rating-value">{{ avg_rating }}</div>
                    </div>
                </div>
            </article>
        </section>

        <section class="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
            <div class="px-6 pt-5 pb-3 border-b border-gray-100 bg-gray-50/40">
                <div class="inline-flex bg-white border border-gray-200 rounded-xl p-1" role="tablist" aria-label="控制台选项卡">
                    <button
                        id="tab-btn-feedback"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold bg-gradient-to-r from-purple-600 to-pink-600 text-white cursor-pointer"
                        data-target="panel-feedback"
                        type="button"
                    >
                        用户反馈列表
                    </button>
                    <button
                        id="tab-btn-errors"
                        class="tab-btn px-4 py-2 rounded-lg text-sm font-semibold text-gray-500 hover:text-gray-700 cursor-pointer"
                        data-target="panel-errors"
                        type="button"
                    >
                        系统报错日志
                    </button>
                </div>
            </div>

            <div id="panel-feedback" class="tab-panel">
                <div class="px-6 py-4 border-b border-gray-50 flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-white">
                    <h3 class="font-bold text-gray-700">
                        反馈列表
                        <span class="ml-2 text-xs text-gray-400">当前页 <span id="visible-count-value">{{ feedbacks.items|length }}</span> 条 / 共 {{ feedbacks.total }} 条</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <select id="filter-rating" class="text-sm border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500/20">
                            <option value="all">全部评分</option>
                            <option value="5">仅看 5 星</option>
                            <option value="low">3 星及以下</option>
                        </select>
                        <button
                            type="button"
                            onclick="clearAllFeedbacks()"
                            class="inline-flex items-center px-3.5 py-2 rounded-lg bg-red-50 border border-red-200 text-red-600 text-sm font-semibold hover:bg-red-100 transition-colors shadow-sm cursor-pointer"
                        >
                            一键清空
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50 text-xs uppercase text-gray-400 font-semibold">
                                <th class="px-6 py-4 w-20">序号</th>
                                <th class="px-6 py-4 w-40">提交时间</th>
                                <th class="px-6 py-4 w-28">MBTI</th>
                                <th class="px-6 py-4 w-40">评分</th>
                                <th class="px-6 py-4">反馈内容</th>
                                <th class="px-6 py-4 w-24 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-50 text-sm" id="table-body">
                            {% for item in feedbacks.items %}
                            <tr id="row-{{ item.id }}" class="hover:bg-purple-50/30 transition-colors" data-id="{{ item.id }}" data-rating="{{ item.rating }}">
                                <td class="px-6 py-4 font-mono text-gray-500 text-sm font-bold row-index">{{ loop.index }}</td>
                                <td class="px-6 py-4 text-gray-500 whitespace-nowrap">{{ (item.created_at + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M') if item.created_at else '-' }}</td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex px-2.5 py-1 rounded-md text-xs font-bold bg-purple-50 text-purple-700">
                                        {{ item.mbti_type or 'Unknown' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4">
                                    <span class="text-yellow-400 tracking-widest">{{ '★' * item.rating }}</span><span class="text-gray-200 tracking-widest">{{ '★' * (5 - item.rating) }}</span>
                                </td>
                                <td class="px-6 py-4 text-gray-700 leading-relaxed">{{ item.content or '（用户未填写）' }}</td>
                                <td class="px-6 py-4 text-right">
                                    <button
                                        type="button"
                                        class="delete-btn inline-flex items-center justify-center w-9 h-9 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition-colors cursor-pointer"
                                        data-id="{{ item.id }}"
                                        title="删除"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m-7 0V5a1 1 0 011-1h4a1 1 0 011 1v2" />
                                        </svg>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr id="initial-empty-row">
                                <td colspan="6" class="px-6 py-20 text-center text-gray-400">暂无反馈数据</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="px-6 py-4 border-t border-gray-100 bg-gray-50/40 flex items-center justify-between">
                    <p class="text-xs text-gray-400">反馈分页：第 {{ feedbacks.page }} / {{ feedbacks.pages }} 页</p>
                    <div class="flex items-center gap-2">
                        {% if feedbacks.has_prev %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ feedbacks.prev_num }}&page_error={{ error_logs.page }}&active_tab=feedback"
                            class="px-3 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 text-sm hover:bg-gray-100 transition-colors"
                        >上一页</a>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-lg border border-gray-100 bg-gray-100 text-gray-300 text-sm cursor-not-allowed">上一页</span>
                        {% endif %}

                        {% for p in range(1, feedbacks.pages + 1) %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ p }}&page_error={{ error_logs.page }}&active_tab=feedback"
                            class="px-3 py-1.5 rounded-lg text-sm border {{ 'bg-purple-600 border-purple-600 text-white' if p == feedbacks.page else 'bg-white border-gray-200 text-gray-600 hover:bg-gray-100' }} transition-colors"
                        >{{ p }}</a>
                        {% endfor %}

                        {% if feedbacks.has_next %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ feedbacks.next_num }}&page_error={{ error_logs.page }}&active_tab=feedback"
                            class="px-3 py-1.5 rounded-lg border border-gray-200 bg-white text-gray-600 text-sm hover:bg-gray-100 transition-colors"
                        >下一页</a>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-lg border border-gray-100 bg-gray-100 text-gray-300 text-sm cursor-not-allowed">下一页</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div id="panel-errors" class="tab-panel hidden bg-red-50/40">
                <div class="px-6 py-4 border-b border-red-100 bg-red-50/70 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                    <div>
                        <h3 class="font-bold text-red-700">系统报错日志</h3>
                        <p class="text-xs text-red-500 mt-1">记录 AI 生成异常与原始响应，便于快速排查线上问题。</p>
                    </div>
                    <button
                        type="button"
                        onclick="clearAllErrors()"
                        class="inline-flex items-center px-3.5 py-2 rounded-lg bg-red-500 border border-red-500 text-white text-sm font-semibold hover:bg-red-600 transition-colors shadow-sm cursor-pointer"
                    >
                        一键清空日志
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-red-50 border-b border-red-100 text-xs uppercase text-red-400 font-semibold">
                                <th class="px-6 py-4 w-20">ID</th>
                                <th class="px-6 py-4 w-44">报错时间</th>
                                <th class="px-6 py-4 w-40">错误类型</th>
                                <th class="px-6 py-4">错误详情</th>
                                <th class="px-6 py-4 w-32 text-right">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-red-100 text-sm">
                            {% for item in error_logs.items %}
                            <tr class="hover:bg-red-100/40 transition-colors">
                                <td class="px-6 py-4 font-mono text-red-500">#{{ item.id }}</td>
                                <td class="px-6 py-4 text-red-500 whitespace-nowrap text-xs">
                                    {{ (item.created_at + timedelta(hours=8)).strftime('%Y-%m-%d %H:%M:%S') if item.created_at else '-' }}
                                </td>
                                <td class="px-6 py-4">
                                    <span class="inline-flex px-2.5 py-1 rounded-md text-xs font-semibold bg-white text-red-600 border border-red-200">
                                        {{ item.error_type or 'Exception' }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-red-600 text-xs font-mono break-all whitespace-pre-wrap max-w-md">
                                    {{ item.error_msg or '（无错误详情）' }}
                                </td>
                                <td class="px-6 py-4 text-right">
                                    <div class="inline-flex items-center gap-2">
                                        <button
                                            type="button"
                                            class="view-raw-btn inline-flex px-3 py-1.5 rounded-lg bg-white border border-red-200 text-red-600 text-xs hover:bg-red-50 transition-colors cursor-pointer"
                                        >
                                            查看
                                        </button>
                                        <button
                                            type="button"
                                            onclick="deleteErrorLog({{ item.id }})"
                                            class="inline-flex px-3 py-1.5 rounded-lg bg-red-500 border border-red-500 text-white text-xs hover:bg-red-600 transition-colors shadow-sm cursor-pointer"
                                        >
                                            删除
                                        </button>
                                    </div>
                                    <span class="raw-value hidden">{{ item.raw_response or '' }}</span>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="px-6 py-20 text-center text-red-300">暂无系统报错日志</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="px-6 py-4 border-t border-red-100 bg-red-50/40 flex items-center justify-between">
                    <p class="text-xs text-red-400">报错分页：第 {{ error_logs.page }} / {{ error_logs.pages }} 页</p>
                    <div class="flex items-center gap-2">
                        {% if error_logs.has_prev %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ feedbacks.page }}&page_error={{ error_logs.prev_num }}&active_tab=errors"
                            class="px-3 py-1.5 rounded-lg border border-red-200 bg-white text-red-600 text-sm hover:bg-red-50 transition-colors"
                        >上一页</a>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-lg border border-red-100 bg-red-100/60 text-red-200 text-sm cursor-not-allowed">上一页</span>
                        {% endif %}

                        {% for p in range(1, error_logs.pages + 1) %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ feedbacks.page }}&page_error={{ p }}&active_tab=errors"
                            class="px-3 py-1.5 rounded-lg text-sm border {{ 'bg-red-500 border-red-500 text-white' if p == error_logs.page else 'bg-white border-red-200 text-red-600 hover:bg-red-50' }} transition-colors"
                        >{{ p }}</a>
                        {% endfor %}

                        {% if error_logs.has_next %}
                        <a
                            href="{{ request.url.path }}?key={{ request.query_params.get('key', '') }}&page_feedback={{ feedbacks.page }}&page_error={{ error_logs.next_num }}&active_tab=errors"
                            class="px-3 py-1.5 rounded-lg border border-red-200 bg-white text-red-600 text-sm hover:bg-red-50 transition-colors"
                        >下一页</a>
                        {% else %}
                        <span class="px-3 py-1.5 rounded-lg border border-red-100 bg-red-100/60 text-red-200 text-sm cursor-not-allowed">下一页</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>
    </main>

    <div id="delete-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-900/60 backdrop-blur-sm transition-opacity opacity-0">
        <div id="delete-modal-content" class="bg-white rounded-2xl p-6 w-[90%] max-w-sm shadow-2xl transform scale-95 transition-transform duration-200">
            <h3 class="text-xl font-bold text-gray-900 mb-2">确认操作</h3>
            <p id="delete-modal-msg" class="text-gray-500 text-sm mb-6">您确定要执行此删除操作吗？</p>

            <div class="flex flex-col gap-3">
                <button id="btn-confirm-delete" type="button" class="w-full py-2.5 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl transition-colors cursor-pointer">
                    确认删除
                </button>

                <button id="btn-mute-delete" type="button" class="hidden w-full py-2.5 bg-red-50 hover:bg-red-100 text-red-600 font-bold rounded-xl border border-red-200 transition-colors cursor-pointer">
                    删除且今日不再提醒
                </button>

                <button type="button" onclick="closeDeleteModal()" class="w-full py-2.5 text-gray-400 font-bold hover:text-gray-600 transition-colors cursor-pointer">
                    取消
                </button>
            </div>
        </div>
    </div>

    <div id="raw-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-gray-900/55 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-[92%] max-w-3xl shadow-2xl overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">原始响应数据</h3>
                <button id="close-raw-btn" type="button" class="text-gray-400 hover:text-gray-600 text-xl leading-none cursor-pointer">×</button>
            </div>
            <div class="p-5 max-h-[60vh] overflow-auto bg-gray-50">
                <pre id="raw-content" class="text-xs leading-6 text-gray-700 whitespace-pre-wrap break-words"></pre>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
            const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));

            const filterRating = document.getElementById('filter-rating');
            const tableBody = document.getElementById('table-body');
            const totalCountValue = document.getElementById('total-count-value');
            const avgRatingValue = document.getElementById('avg-rating-value');
            const visibleCountValue = document.getElementById('visible-count-value');
            const dynamicEmptyRowId = 'dynamic-empty-row';

            const deleteModal = document.getElementById('delete-modal');
            const deleteModalContent = document.getElementById('delete-modal-content');
            const deleteModalMsg = document.getElementById('delete-modal-msg');
            const confirmDeleteBtn = document.getElementById('btn-confirm-delete');
            const muteDeleteBtn = document.getElementById('btn-mute-delete');

            const rawModal = document.getElementById('raw-modal');
            const rawContent = document.getElementById('raw-content');
            const closeRawBtn = document.getElementById('close-raw-btn');

            const adminKey = new URLSearchParams(window.location.search).get('key') || '';
            const todayString = () => new Date().toDateString();

            function handleOperationError(error) {
                console.error(error);
                alert('操作失败，请稍后重试');
            }

            async function runModalAction(action) {
                if (typeof action !== 'function') return;
                try {
                    await action();
                } catch (error) {
                    handleOperationError(error);
                } finally {
                    closeDeleteModal();
                }
            }

            function openModal(msg, action, allowMute) {
                if (!deleteModal || !deleteModalContent || !deleteModalMsg) return;

                deleteModalMsg.innerText = msg;
                confirmDeleteBtn.onclick = () => runModalAction(action);

                if (allowMute) {
                    muteDeleteBtn.classList.remove('hidden');
                    muteDeleteBtn.onclick = () => {
                        localStorage.setItem('admin_mute_delete_date', todayString());
                        runModalAction(action);
                    };
                } else {
                    muteDeleteBtn.classList.add('hidden');
                    muteDeleteBtn.onclick = null;
                }

                deleteModal.classList.remove('hidden');
                setTimeout(() => {
                    deleteModal.classList.remove('opacity-0');
                    deleteModalContent.classList.remove('scale-95');
                    deleteModalContent.classList.add('scale-100');
                }, 10);
            }

            function closeDeleteModal() {
                if (!deleteModal || !deleteModalContent) return;
                deleteModal.classList.add('opacity-0');
                deleteModalContent.classList.remove('scale-100');
                deleteModalContent.classList.add('scale-95');
                setTimeout(() => {
                    deleteModal.classList.add('hidden');
                }, 180);
            }

            window.closeDeleteModal = closeDeleteModal;

            function switchTab(targetId) {
                tabButtons.forEach((button) => {
                    const isActive = button.dataset.target === targetId;
                    button.classList.toggle('bg-gradient-to-r', isActive);
                    button.classList.toggle('from-purple-600', isActive);
                    button.classList.toggle('to-pink-600', isActive);
                    button.classList.toggle('text-white', isActive);
                    button.classList.toggle('text-gray-500', !isActive);
                });

                tabPanels.forEach((panel) => {
                    panel.classList.toggle('hidden', panel.id !== targetId);
                });
            }

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => switchTab(button.dataset.target));
            });

            function getFeedbackRows() {
                if (!tableBody) return [];
                return Array.from(tableBody.querySelectorAll('tr[data-rating]'));
            }

            function removeDynamicEmptyRow() {
                const emptyNode = document.getElementById(dynamicEmptyRowId);
                if (emptyNode) emptyNode.remove();
            }

            function renderDynamicEmptyRow(message) {
                removeDynamicEmptyRow();
                if (!tableBody) return;
                const row = document.createElement('tr');
                row.id = dynamicEmptyRowId;
                row.innerHTML = `<td colspan="6" class="px-6 py-20 text-center text-gray-400">${message}</td>`;
                tableBody.appendChild(row);
            }

            function refreshRowIndexes() {
                const rows = getFeedbackRows();
                rows.forEach((row, index) => {
                    const idxCell = row.querySelector('.row-index');
                    if (idxCell) {
                        idxCell.textContent = String(index + 1);
                    }
                });
            }

            function updateSummaryCards() {
                const rows = getFeedbackRows();
                const total = rows.length;
                const scoreSum = rows.reduce((sum, row) => sum + (parseInt(row.getAttribute('data-rating')) || 0), 0);
                const avg = total > 0 ? (scoreSum / total).toFixed(1) : '0.0';

                if (totalCountValue) totalCountValue.textContent = String(total);
                if (avgRatingValue) avgRatingValue.textContent = avg;
            }

            function applyFeedbackFilter() {
                const value = filterRating ? filterRating.value : 'all';
                const rows = getFeedbackRows();
                let visible = 0;

                rows.forEach((row) => {
                    const rating = parseInt(row.getAttribute('data-rating')) || 0;
                    const show = value === 'all' || (value === '5' && rating === 5) || (value === 'low' && rating <= 3);
                    row.style.display = show ? '' : 'none';
                    if (show) visible += 1;
                });

                if (visibleCountValue) visibleCountValue.textContent = String(visible);

                if (rows.length === 0) {
                    renderDynamicEmptyRow('暂无反馈数据');
                } else if (visible === 0) {
                    renderDynamicEmptyRow('当前筛选条件下暂无数据');
                } else {
                    removeDynamicEmptyRow();
                    const initialEmpty = document.getElementById('initial-empty-row');
                    if (initialEmpty) initialEmpty.remove();
                }
            }

            async function performFeedbackDelete(id) {
                const response = await fetch(`/admin/delete_feedback/${id}?key=${encodeURIComponent(adminKey)}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const row = document.getElementById(`row-${id}`);
                if (row) {
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        refreshRowIndexes();
                        updateSummaryCards();
                        applyFeedbackFilter();
                    }, 220);
                }
            }

            function isMuteEnabledToday() {
                return localStorage.getItem('admin_mute_delete_date') === todayString();
            }

            function deleteFeedback(id) {
                const performDelete = () => performFeedbackDelete(id);
                if (isMuteEnabledToday()) {
                    performDelete().catch(handleOperationError);
                    return;
                }
                openModal('确定要删除这条反馈吗？删除后不可恢复。', performDelete, true);
            }

            window.deleteErrorLog = function(logId) {
                if (!logId) return;

                const performDelete = async () => {
                    const response = await fetch(`/admin/error_log/${logId}/delete?key=${encodeURIComponent(adminKey)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    location.reload();
                };

                if (isMuteEnabledToday()) {
                    performDelete().catch(handleOperationError);
                    return;
                }

                openModal('确定要删除这条报错日志吗？', performDelete, true);
            };

            window.clearAllFeedbacks = function() {
                const performClear = async () => {
                    const response = await fetch(`/admin/feedbacks/clear?key=${encodeURIComponent(adminKey)}`, {
                        method: 'POST',
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    location.reload();
                };

                openModal('⚠️ 高能预警：确定要清空所有用户反馈吗？不可恢复！', performClear, false);
            };

            window.clearAllErrors = function() {
                const performClear = async () => {
                    const response = await fetch(`/admin/error_logs/clear?key=${encodeURIComponent(adminKey)}`, {
                        method: 'POST',
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    location.reload();
                };

                openModal('⚠️ 高能预警：确定要清空所有系统报错日志吗？', performClear, false);
            };

            document.querySelectorAll('.delete-btn').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const id = Number(btn.getAttribute('data-id'));
                    if (id) deleteFeedback(id);
                });
            });

            function openRawModal(text) {
                rawContent.textContent = text || '（无原始数据）';
                rawModal.classList.remove('hidden');
            }

            function closeRawModal() {
                rawModal.classList.add('hidden');
            }

            document.querySelectorAll('.view-raw-btn').forEach((btn) => {
                btn.addEventListener('click', () => {
                    const raw = btn.parentElement ? btn.parentElement.querySelector('.raw-value') : null;
                    openRawModal(raw ? raw.textContent : '');
                });
            });

            if (closeRawBtn) closeRawBtn.addEventListener('click', closeRawModal);
            rawModal.addEventListener('click', (event) => {
                if (event.target === rawModal) closeRawModal();
            });

            if (filterRating) {
                filterRating.addEventListener('change', applyFeedbackFilter);
            }

            refreshRowIndexes();
            applyFeedbackFilter();

            const urlParams = new URLSearchParams(window.location.search);
            const activeTab = urlParams.get('active_tab');
            const feedbackTabBtn = document.getElementById('tab-btn-feedback');
            const errorTabBtn = document.getElementById('tab-btn-errors');

            if (activeTab === 'errors') {
                errorTabBtn?.click();
            } else {
                feedbackTabBtn?.click();
            }
        });
    </script>
</body>
</html>
